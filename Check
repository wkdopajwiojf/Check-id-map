--[[ 
DXD Relay UI v8 Final
ðŸ–¤ Features:
- Banlist check
- Map-based loader
- Discord webhook on join/leave
- Global chat relay (Roblox <-> Discord, cross server)
- Join / Leave broadcast (English system messages)
- Owner highlight (Lunarplyr / jeffyhey)
- Time tags [HH:MM]
- Auto-scroll
- Ping sound + mute toggle
- Popup notification on new message
- Smooth UI container (rounded dark panel)
- Keeps UI branding text in Thai (Powered by à¸¥à¸¸à¸‡à¸­à¸²à¸£à¹Œà¸¡ (Lunarplyr))
]]

-------------------------------------------------
-- 1. Banlist Check
-------------------------------------------------
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer

print("Checking Banlist ðŸ”ƒ")
for i = 1, 100, math.random(5, 15) do
	task.wait(0.05)
	print("Loading... " .. i .. "%")
end
print("Loading... 100% âœ…")

local isBanned = loadstring(game:HttpGet(
	"https://raw.githubusercontent.com/wkdopajwiojf/Zombie-game/main/Ban%20land"
))()
if isBanned then
	print("Ban âŒ")
	return
end
print("Success âœ…")

-------------------------------------------------
-- 2. Map Loader (per game.PlaceId)
-------------------------------------------------
local mapId = game.PlaceId
if mapId == 138365924124161 then
	loadstring(game:HttpGet("https://raw.githubusercontent.com/wkdopajwiojf/Backrooms-Drift/refs/heads/main/Script"))()
elseif mapId == 14419907512 then
	loadstring(game:HttpGet("https://raw.githubusercontent.com/wkdopajwiojf/Zombie-game/refs/heads/main/Eng%20version%20%E0%B8%94%E0%B8%B1%E0%B8%94%E0%B9%81%E0%B8%9B%E0%B8%A5%E0%B8%87%20script%20%E0%B8%97%E0%B8%B5%E0%B9%88%E0%B8%99%E0%B8%B5%E0%B9%88"))()
elseif mapId == 9872472334 then
	loadstring(game:HttpGet("https://raw.githubusercontent.com/wkdopajwiojf/evade-bypass-countdown/refs/heads/main/Protected_8932730771877973.lua.txt"))()
elseif mapId == 10449761463 or mapId == 14835828495 or mapId == 17455699549 then
	loadstring(game:HttpGet("https://raw.githubusercontent.com/wkdopajwiojf/dww/refs/heads/main/i"))()
else
	loadstring(game:HttpGet("https://raw.githubusercontent.com/wkdopajwiojf/Check-id-map/refs/heads/main/Chat%20with%20me"))()
	return
end

-------------------------------------------------
-- 3. Networking setup
-------------------------------------------------
-- executor HTTP function
local REQUEST = (syn and syn.request) or http_request or request or (fluxus and fluxus.request)
assert(REQUEST, "Executor à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š request (syn.request / http_request / request / fluxus.request)")

-- relay config (Render server)
local RELAY_URL = "https://dxd-1.onrender.com"
local RELAY_KEY = "222554"

-- discord webhook for join/leave logging
local DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1412800788828258365/yk13Av7fcp8nLLZugFNWNJxY-Td2Bb3K11Jbazrc9JJVcXfmdsRR9i45Ii3s-uqawVo0"

local function sendDiscordWebhook(content)
	local body = HttpService:JSONEncode({content = content})
	pcall(function()
		REQUEST({
			Url = DISCORD_WEBHOOK,
			Method = "POST",
			Headers = {["Content-Type"] = "application/json"},
			Body = body
		})
	end)
end

-- announce self join to Discord
sendDiscordWebhook(("âš¡ %s joined the game (executor)") :format(player.Name))

-- announce self leaving/teleport
player.OnTeleport:Connect(function()
	sendDiscordWebhook(("ðŸ’¨ %s left the game / teleporting"):format(player.Name))
end)

-------------------------------------------------
-- 4. UI setup
-------------------------------------------------
local screen = Instance.new("ScreenGui")
screen.Name = "DXD_ChatUI"
screen.ResetOnSpawn = false
screen.IgnoreGuiInset = false
screen.Parent = game:GetService("CoreGui")

-- main window
local frame = Instance.new("Frame")
frame.Name = "MainWindow"
frame.Parent = screen
frame.AnchorPoint = Vector2.new(1,1)
frame.Position = UDim2.new(1,-16,1,-16)
frame.Size = UDim2.new(0,360,0,260)
frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
frame.BackgroundTransparency = 0.08
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
local frameCorner = Instance.new("UICorner", frame)
frameCorner.CornerRadius = UDim.new(0,12)

-- title bar (kept Thai name style like you wanted)
local titleBar = Instance.new("Frame")
titleBar.Parent = frame
titleBar.BackgroundTransparency = 1
titleBar.Size = UDim2.new(1,0,0,28)
titleBar.Position = UDim2.new(0,0,0,0)

local title = Instance.new("TextLabel")
title.Parent = titleBar
title.BackgroundTransparency = 1
title.Position = UDim2.new(0,0,0,0)
title.Size = UDim2.new(1,0,1,0)
title.Text = "DXD Global Chat by à¸¥à¸¸à¸‡à¸­à¸²à¸£à¹Œà¸¡"
title.Font = Enum.Font.GothamBlack
title.TextSize = 20
title.TextColor3 = Color3.fromRGB(255,150,80)
title.TextXAlignment = Enum.TextXAlignment.Center
title.TextStrokeTransparency = 0.7

-- mute / unmute button
local soundEnabled = true
local muteBtn = Instance.new("TextButton")
muteBtn.Parent = titleBar
muteBtn.Size = UDim2.new(0,32,1,0)
muteBtn.Position = UDim2.new(0,8,0,0)
muteBtn.BackgroundTransparency = 1
muteBtn.Font = Enum.Font.GothamBold
muteBtn.TextSize = 20
muteBtn.TextColor3 = Color3.fromRGB(200,200,200)
muteBtn.Text = "ðŸ”Š"

muteBtn.MouseButton1Click:Connect(function()
	soundEnabled = not soundEnabled
	muteBtn.Text = soundEnabled and "ðŸ”Š" or "ðŸ”‡"
end)

-- minimize button
local minBtn = Instance.new("TextButton")
minBtn.Parent = titleBar
minBtn.Size = UDim2.new(0,32,1,0)
minBtn.Position = UDim2.new(1,-40,0,0)
minBtn.Text = "â€“"
minBtn.Font = Enum.Font.GothamBlack
minBtn.TextColor3 = Color3.fromRGB(220,220,220)
minBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
minBtn.BackgroundTransparency = 0.3
local minCorner = Instance.new("UICorner", minBtn)
minCorner.CornerRadius = UDim.new(0,8)

-- chat scrolling area
local messages = Instance.new("ScrollingFrame")
messages.Name = "Messages"
messages.Parent = frame
messages.BackgroundTransparency = 1
messages.BorderSizePixel = 0
messages.Position = UDim2.new(0,10,0,38)
messages.Size = UDim2.new(1,-20,1,-90)
messages.CanvasSize = UDim2.new(0,0,0,0)
messages.ScrollBarThickness = 6
messages.ScrollBarImageTransparency = 0.3
messages.ScrollBarImageColor3 = Color3.fromRGB(200,200,200)
local msgCorner = Instance.new("UICorner", messages)
msgCorner.CornerRadius = UDim.new(0,8)

local layout = Instance.new("UIListLayout")
layout.Parent = messages
layout.Padding = UDim.new(0,6)
layout.SortOrder = Enum.SortOrder.LayoutOrder

-- input
local textBox = Instance.new("TextBox")
textBox.Parent = frame
textBox.Position = UDim2.new(0,10,1,-42)
textBox.Size = UDim2.new(1,-120,0,32)
textBox.BackgroundColor3 = Color3.fromRGB(35,35,35)
textBox.BackgroundTransparency = 0.15
textBox.BorderSizePixel = 0
textBox.PlaceholderText = "Type..."
textBox.ClearTextOnFocus = false
textBox.Font = Enum.Font.Gotham
textBox.TextSize = 18
textBox.TextColor3 = Color3.fromRGB(255,255,255)
textBox.TextXAlignment = Enum.TextXAlignment.Left
textBox.Text = ""
local tbCorner = Instance.new("UICorner", textBox)
tbCorner.CornerRadius = UDim.new(0,8)

local sendBtn = Instance.new("TextButton")
sendBtn.Parent = frame
sendBtn.Position = UDim2.new(1,-98,1,-42)
sendBtn.Size = UDim2.new(0,88,0,32)
sendBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
sendBtn.BackgroundTransparency = 0.08
sendBtn.BorderSizePixel = 0
sendBtn.Font = Enum.Font.GothamBlack
sendBtn.TextSize = 19
sendBtn.TextColor3 = Color3.fromRGB(230,230,230)
sendBtn.Text = "Send"
local sbCorner = Instance.new("UICorner", sendBtn)
sbCorner.CornerRadius = UDim.new(0,8)

local credit = Instance.new("TextLabel")
credit.Parent = frame
credit.Size = UDim2.new(1,-20,0,16)
credit.Position = UDim2.new(0,10,1,-20)
credit.BackgroundTransparency = 1
credit.Font = Enum.Font.Gotham
credit.TextSize = 13
credit.TextColor3 = Color3.fromRGB(120,180,255)
credit.TextXAlignment = Enum.TextXAlignment.Right
credit.Text = "Powered by à¸¥à¸¸à¸‡à¸­à¸²à¸£à¹Œà¸¡ (Lunarplyr)"

-------------------------------------------------
-- 5. Utility stuff
-------------------------------------------------
-- sound ping (discord-ish)
local pingSound = Instance.new("Sound")
pingSound.SoundId = "rbxassetid://6534947246" -- chill ping
pingSound.Volume = 0.7
pingSound.Parent = SoundService

local function playPing()
	if soundEnabled then
		pingSound:Play()
	end
end

-- time tag display
local function getTimeTag()
	local t = os.date("*t")
	return string.format("[%02d:%02d]", t.hour, t.min)
end

-- scroll bottom helper
local function scrollToBottom()
	task.wait()
	messages.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 10)
	messages.CanvasPosition = Vector2.new(
		0,
		math.max(0, layout.AbsoluteContentSize.Y - messages.AbsoluteWindowSize.Y)
	)
end

-- roblox notification popup
local function pushPopup(txt)
	pcall(function()
		game:GetService("StarterGui"):SetCore("SendNotification", {
			Title = "DXD Chat",
			Text = txt,
			Duration = 3
		})
	end)
end

-------------------------------------------------
-- 6. Message rendering
-------------------------------------------------
-- addChatMessage = à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸› (à¸ˆà¸²à¸à¸„à¸™à¸„à¸¸à¸¢)
-- addSystemMessage = à¸ªà¸³à¸«à¸£à¸±à¸š join/leave à¹à¸šà¸š global ANNOUNCE à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©
local function addChatMessage(author, text, isSelf)
	local lbl = Instance.new("TextLabel")
	lbl.Parent = messages
	lbl.BackgroundTransparency = 1
	lbl.Font = Enum.Font.Gotham
	lbl.TextSize = 18
	lbl.TextWrapped = true
	lbl.AutomaticSize = Enum.AutomaticSize.XY
	lbl.Size = UDim2.new(1,0,0,0)
	lbl.ClipsDescendants = true
	lbl.TextTransparency = 0

	-- Owner highlight
	local displayName = author
	local useColor = Color3.fromRGB(220,220,220)

	if author == "Lunarplyr" then
		displayName = "Owner " .. author
		useColor = Color3.fromRGB(255,80,80)
	elseif author == "[Discord] jeffyhey" or author == "jeffyhey" then
		displayName = "Owner " .. author
		useColor = Color3.fromRGB(255,120,120)
	end

	local t = getTimeTag()

	if isSelf then
		-- our own message -> right aligned blue
		lbl.Text = string.format("%s :%s %s", text, displayName, t)
		lbl.TextXAlignment = Enum.TextXAlignment.Right
		lbl.TextColor3 = Color3.fromRGB(100,200,255)
	else
		-- others -> left aligned
		lbl.Text = string.format("%s %s: %s", t, displayName, text)
		lbl.TextXAlignment = Enum.TextXAlignment.Left
		lbl.TextColor3 = useColor
	end

	scrollToBottom()
end

local function addSystemMessage(text)
	local lbl = Instance.new("TextLabel")
	lbl.Parent = messages
	lbl.BackgroundTransparency = 1
	lbl.Font = Enum.Font.GothamItalic
	lbl.TextSize = 16
	lbl.TextWrapped = true
	lbl.AutomaticSize = Enum.AutomaticSize.XY
	lbl.Size = UDim2.new(1,0,0,0)
	lbl.ClipsDescendants = true
	lbl.TextColor3 = Color3.fromRGB(180,180,180)
	lbl.TextXAlignment = Enum.TextXAlignment.Center
	lbl.Text = text

	scrollToBottom()
end

-------------------------------------------------
-- 7. Send message handler
-------------------------------------------------
local function relaySendChat(txt)
	local body = HttpService:JSONEncode({
		author = player.Name,
		text = txt,
		type = "chat"
	})
	pcall(function()
		REQUEST({
			Url = RELAY_URL .. "/to-discord",
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json",
				["x-relay-key"] = RELAY_KEY,
			},
			Body = body
		})
	end)
end

local function handleSend()
	local txt = textBox.Text
	if txt ~= "" then
		addChatMessage(player.Name, txt, true)
		relaySendChat(txt)
		textBox.Text = ""
	end
end

sendBtn.MouseButton1Click:Connect(handleSend)
textBox.FocusLost:Connect(function(enterPressed)
	if enterPressed then
		handleSend()
	end
end)

-------------------------------------------------
-- 8. Minimize / Expand with smooth tween & fade
-------------------------------------------------
local minimized = false
local animing = false
local EXPANDED_SIZE = UDim2.new(0,360,0,260)
local COLLAPSED_SIZE = UDim2.new(0,200,0,50)
local FADE_TIME = 0.3
local SHRINK_TIME = 0.3

-- elements we hide (fade)
local fadeGroup = {messages, textBox, sendBtn, credit}

local function tweenProp(obj, timeSec, props)
	local tw = TweenService:Create(
		obj,
		TweenInfo.new(timeSec, Enum.EasingStyle.Sine, Enum.EasingDirection.Out),
		props
	)
	tw:Play()
	return tw
end

local function fadeGroupTo(hiddenBool)
	for _,inst in ipairs(fadeGroup) do
		if inst:IsA("TextLabel") or inst:IsA("TextButton") or inst:IsA("TextBox") then
			tweenProp(inst, FADE_TIME, {TextTransparency = hiddenBool and 1 or 0})
		end
		if inst.BackgroundTransparency ~= nil then
			local target = hiddenBool and math.clamp((inst.BackgroundTransparency or 0) + 0.5,0,1) or 0.15
			tweenProp(inst, FADE_TIME, {BackgroundTransparency = target})
		end
	end
end

minBtn.MouseButton1Click:Connect(function()
	if animing then return end
	animing = true

	if not minimized then
		-- going to MINIMIZED
		fadeGroupTo(true)
		task.delay(FADE_TIME, function()
			for _,inst in ipairs(fadeGroup) do inst.Visible = false end
			local t = tweenProp(frame, SHRINK_TIME, {Size = COLLAPSED_SIZE})
			t.Completed:Connect(function()
				minimized = true
				minBtn.Text = "+"
				animing = false
			end)
		end)
	else
		-- going back to EXPANDED
		local t = tweenProp(frame, SHRINK_TIME, {Size = EXPANDED_SIZE})
		t.Completed:Connect(function()
			for _,inst in ipairs(fadeGroup) do
				inst.Visible = true
				if inst == textBox then
					inst.BackgroundTransparency = 0.15
				end
			end
			fadeGroupTo(false)
			task.delay(FADE_TIME, function()
				minimized = false
				minBtn.Text = "â€“"
				animing = false
				scrollToBottom()
			end)
		end)
	end
end)

-------------------------------------------------
-- 9. Poll global messages from relay
-------------------------------------------------
-- Server side (relay) is expected to send JSON like:
-- {
--   ok = true,
--   messages = {
--      { id=1, type="chat", author="Name", text="hello" },
--      { id=2, type="join", author="Name" },
--      { id=3, type="leave", author="Name" },
--      ...
--   }
-- }
--
-- We'll render:
--  chat  -> addChatMessage(author, text, false)
--  join  -> addSystemMessage("âš¡ Name joined the game")
--  leave -> addSystemMessage("ðŸ’¨ Name left the game")

local function handleIncoming(msg)
	local mType = msg.type or "chat"
	local author = tostring(msg.author or "???")
	if mType == "chat" then
		local text = tostring(msg.text or "")
		if text ~= "" then
			addChatMessage(author, text, false)
			playPing()
			pushPopup("New message")
		end
	elseif mType == "join" then
		addSystemMessage(("âš¡ %s joined the game"):format(author))
		playPing()
	elseif mType == "leave" then
		addSystemMessage(("ðŸ’¨ %s left the game"):format(author))
		playPing()
	end
end

task.spawn(function()
	local lastId = 0
	while true do
		local ok, res = pcall(function()
			return REQUEST({
				Url = RELAY_URL .. "/messages",
				Method = "GET",
				Headers = {["x-relay-key"]=RELAY_KEY}
			})
		end)

		if ok and res and res.StatusCode == 200 and res.Body then
			local decoded
			local success = pcall(function()
				decoded = HttpService:JSONDecode(res.Body)
			end)

			if success and decoded and decoded.ok and decoded.messages then
				for _,m in ipairs(decoded.messages) do
					if not m.id or m.id > lastId then
						handleIncoming(m)
						if typeof(m.id) == "number" and m.id > lastId then
							lastId = m.id
						end
					end
				end
			end
		end

		task.wait(1)
	end
end)

-------------------------------------------------
-- 10. bootstrap
-------------------------------------------------
addSystemMessage("DXD Relay ready âœ…")
